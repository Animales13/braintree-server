<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pago Braintree Producción</title>
    <script src="https://js.braintreegateway.com/web/dropin/1.40.0/js/dropin.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        #dropin-container { margin-bottom: 20px; }
        #result { margin-top: 20px; font-weight: bold; }
        input, button { padding: 10px; font-size: 16px; margin-top: 5px; }
        input { width: 100px; }
    </style>
</head>
<body>
    <h1>Pago Braintree Producción</h1>

    <label for="amount">Monto a cobrar ($):</label>
    <input type="number" id="amount" value="1.00" step="0.01" min="0.01">

    <div id="dropin-container"></div>
    <button id="pay-button">Pagar</button>
    <div id="result"></div>

    <script>
        const button = document.querySelector('#pay-button');
        const resultDiv = document.querySelector('#result');

        fetch('/client_token')
            .then(res => res.json())
            .then(data => {
                if(data.error){
                    resultDiv.textContent = 'Error al obtener client token: ' + data.error;
                    return;
                }

                braintree.dropin.create({
                    authorization: data.clientToken,
                    container: '#dropin-container'
                }, (err, instance) => {
                    if (err) {
                        resultDiv.textContent = 'Error al cargar Drop-in: ' + err;
                        return;
                    }

                    button.addEventListener('click', () => {
                        const amount = document.querySelector('#amount').value;
                        instance.requestPaymentMethod((err, payload) => {
                            if (err) {
                                resultDiv.textContent = 'Error al obtener método de pago: ' + err;
                                return;
                            }

                            fetch('/checkout', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ nonce: payload.nonce, amount: amount })
                            })
                            .then(res => res.json())
                            .then(res => {
                                if (res.success) {
                                    resultDiv.textContent = 'Pago exitoso! Transaction ID: ' + res.transaction_id;
                                } else {
                                    resultDiv.textContent = 'Pago fallido: ' + (res.message || res.error);
                                }
                            })
                            .catch(err => {
                                resultDiv.textContent = 'Error al procesar el pago: ' + err;
                            });
                        });
                    });
                });
            })
            .catch(err => {
                resultDiv.textContent = 'Error al obtener client token: ' + err;
            });
    </script>
</body>
</html>
